<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>大医精诚</title>
  <link rel="stylesheet" href="css/normalize.css">
  <link rel="stylesheet" href="css/user.css">
</head>
<body>
  <audio class="phone_audio" loop preload autoplay src="images/phone.mp3"></audio>
  <header>
    <img src="images/title.png">
    <img src="images/small_title.png" class="small_title">
  </header>
  <section>
    <div class="doctor_info">
      <img src="images/doc2.png" alt="">
    </div>
    <div class="chat">
      <div class="box1">
        <video src="" id='other_video' autoplay></video>
      </div>
      <div class="box2">
        <video src="" id='my_video' autoplay></video>
      </div>
      <div class="call">
        <p>等待对方接听<br/>......</p>
      </div>
      <div class="control">
        <p>通话时长&nbsp;<span class="timeDOM">00:00</span></p>
      </div>
      <div class="breaklink">
        <p>断开链接<span class="breaktime">5</span>秒后退出</p>
      </div>
    </div>
  </section>
  <script src='js/SkyRTC-client.js'></script>
  <script>
    var my_video = document.querySelector('#my_video');
    var other_video = document.querySelector('#other_video');
    var call_container = document.querySelector('.call');
    var control = document.querySelector('.control');
    var breaklink = document.querySelector('.breaklink');
    var phone_audio = document.querySelector('.phone_audio');
    //接收到文字信息, 判断呼叫流程
    var state_1 = 'user call';    //呼叫中
    var state_2 = 'doc answer';   //接听电话
    var state_3 = 'doc hang up';  //挂断电话
    //存放的全局变量
    var other_stream;

    var rtc = new SkyRTC();
    //连接WebSocket服务器
    rtc.connect("wss://" + window.location.host + '/node/doc2_room', 'user2', 'doc2_room');

    //成功创建WebSocket连接
    rtc.on("connected", function(socket) {
        //创建本地视频流
        rtc.createStream({
            "video": true,
            "audio": true
        });
    });

    //创建本地视频流成功
    rtc.on("stream_created", function(stream) {
      my_video.srcObject = stream;
      my_video.muted = true;
      my_video.play();
    });

    //创建本地视频流失败
    rtc.on("stream_create_error", function() {
        alert("不支持webRTC, 请在windows下的chrome浏览器中运行");
    });

    //接收到其他用户的视频流
    rtc.on('pc_add_stream', function(stream, socketId) {
      setTimeout(function(){
        rtc.broadcast(state_1);
      },1000)
      other_stream = stream;
    });

    //删除其他用户
    rtc.on('remove_peer', function(socketId) {
      //删除视频流
      if(other_video){
        other_video.setAttribute('src',' ')
      }
      doc_break();
      stop_time();
    });

    //等待20秒，无人接听则返回
    var isOK = false;
    setTimeout(function(){
      if(!isOK){
        window.location.href = 'https://weixin.touchworld-sh.com/node/choose.html';
      }
    },20000)

    //接受状态
    rtc.on('data_channel_message', function(channel, socketId, message){
      //医生接听
      if(message === state_2) {
        isOK = true;
        doc_call();
      }
      //医生挂断
      if(message === state_3) {
        isOK = true;
        //删除视频流
        if(other_video){
          other_video.setAttribute('src',' ')
        }
        doc_break();
        stop_time();
      }
    })

    //断开连倒计时
    var t = 5;
    var break_timer = null;
    var breaklinkDOM = document.querySelector('.breaklink');
    var breaktime = document.querySelector('.breaktime');
    //医生接听电话
    function doc_call(){
      clearInterval(break_timer);
      t = 5;
      breaktime.innerHTML = t;
      breaklinkDOM.style.display = 'none';
      call_container.style.display = 'none';
      control.style.display = 'block';
      rtc.attachStream(other_stream, 'other_video');
      start_time();
    }
    //断开连接
    function doc_break(){
      clearInterval(break_timer);
      breaktime.innerHTML = t;
      breaklinkDOM.style.display = 'block';
      break_timer = setInterval(function(){
        if(t > 0) {
          t--;
          breaktime.innerHTML = t;
        } else {
          clearInterval(break_timer);
          window.location.href = 'https://weixin.touchworld-sh.com/node/choose.html';
        }
      },1000)
    }

    //时间计时器，返回00：00格式的时间
    var timer = null;
    function start_time(){
      var timeDOM = document.querySelector('.timeDOM');
      var s = 0;
      var m = 0;
      var h = 0;
      var time = '00:00'

      timer = setInterval(function(){
        s = parseInt(s);
        m = parseInt(m);
        h = parseInt(h);
        s++;
        if(s === 60){
          m++;  
          s = 0;
        }
        if(m === 60){
          h++;
          s = 0;
          m = 0;
        }
        //格式化时间
        s = s < 10 ? '0' + s : s;
        m = m < 10 ? '0' + m : m;
        h = h < 10 ? '0' + h : h;
        if(h > 0){
          time = h + ':' + m + ':' + s;
        }else{
          time = m + ':' + s;
        }
        //加入DOM
        timeDOM.innerHTML = time;
      }, 1000)
    }
    function stop_time(){
      clearInterval(timer);
      control.style.display = 'none';
    }
  </script>
</body>
</html>